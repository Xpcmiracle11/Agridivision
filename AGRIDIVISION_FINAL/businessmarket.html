<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Profile - Brand</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/fontawesome5-overrides.min.css">
    <link rel="stylesheet" href="assets/css/Icon-Button.css">
    <link rel="stylesheet" href="assets/css/untitled.css">
<link rel="icon" href="/AGRIDIVISION_FINAL/assets/img/background/icon.png" type="image/png">
</head>

<body id="page-top">
    <div id="wrapper">
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0" style="background: #ffcc49;border-color: #ffcc49;">
            <div class="container-fluid d-flex flex-column p-0"><a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0">
                    <div class="sidebar-brand-icon rotate-n-15" style="transform: rotate(1deg);"><img src="assets/img/background/icon.png" style="width: 50px;height: 50px;transform: rotate(4deg) skew(-159deg);"></div>
                    <div class="sidebar-brand-text mx-3"><span style="transform: rotate(148deg);"><em>Agridivision</em></span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link" href="businessdash.php"><i class="fas fa-tachometer-alt"></i><span><strong><em>Dashboard</em></strong></span></a></li>
                    <li class="nav-item"><a class="nav-link" href="businessprofile.php"><i class="fas fa-user"></i><span><strong><em>Profile</em></strong></span></a></li>
                    <li class="nav-item"><a class="nav-link" href="businessmapping.php"><i class="fas fa-map-marked"></i><span><strong><em>Mapping</em></strong></span></a></li>
                    <li class="nav-item"><a class="nav-link" href="businessmarket.php"><i class="fas fa-cart-plus"></i><span><strong><em>Marketplace</em></strong></span></a></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                    <div class="container-fluid"><button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button"><i class="fas fa-bars"></i></button>
                        <div class="container">
                            <div class="row"><style>
    #liveDateTime {
        text-align: center;
        font-size: 1.5rem;
        margin-top: 20px;
        font-style: italic;
        font-weight: bold;
    }

    @media (max-width: 500px) {
        /* Hide the live date and time on small screens */
        #liveDateTime {
            display: none;
        }
    }

    @media (min-width: 501px) and (max-width: 768px) {
        /* Adjust styles for screens between 501px and 570px */
        #liveDateTime {
            font-size: 0.8rem;
            margin-top: 20px;
        }
    }

    @media (min-width: 769px) and (max-width: 992px) {
        /* Adjust styles for screens between 501px and 570px */
        #liveDateTime {
            font-size: 1.2rem;
            margin-top: 20px;
        }
    }
</style>

<div class="col">
    <p id="liveDateTime"></p>
</div>

<script>
    function updateDateTime() {
        var now = new Date();

        // Format date as mm/dd/yyyy
        var month = (now.getMonth() + 1).toString().padStart(2, '0');
        var day = now.getDate().toString().padStart(2, '0');
        var year = now.getFullYear();
        var dateFormatted = month + '/' + day + '/' + year;

        // Format time in standard format with AM and PM
        var options = { hour: '2-digit', minute: '2-digit', hour12: true };
        var timeFormatted = now.toLocaleTimeString(undefined, options);

        var dateTimeString = dateFormatted + ' ' + timeFormatted;
        document.getElementById('liveDateTime').textContent = dateTimeString;
    }

    // Update the date and time every second
    setInterval(updateDateTime, 1000);

    // Initial call to set the initial content
    updateDateTime();
</script>
<style>
    .weather-container {
        text-align: center;
        margin-top: 20px;
    }

    #current-weather {
        font-size: 1.5rem;
        margin-top: 20px;
        font-style: italic;
        font-weight: bold;
    }

    @media (max-width: 500px) {
        /* Hide the current weather on small screens */
        #current-weather {
            display: none;
        }
    }

    @media (min-width: 501px) and (max-width: 768px) {
        /* Adjust styles for screens between 501px and 768px */
        #current-weather {
            font-size: 0.8rem;
            margin-top: 20px;
        }
    }

    @media (min-width: 769px) and (max-width: 992px) {
        /* Adjust styles for screens between 769px and 992px */
        #current-weather {
            font-size: 1.2rem;
            margin-top: 20px;
        }
    }
</style>

<title>Current Weather</title>
<div class="col">
    <div class="weather-container">
        <p id="current-weather"></p>
    </div>
</div>

<script>
    function getCurrentWeather(latitude, longitude) {
        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&hourly=temperature_2m,weathercode`;
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                var currentWeather = data.current_weather;

                var weatherDescription = getWeatherDescription(currentWeather.weathercode);

                var currentWeatherText = `${currentWeather.temperature}°C ${weatherDescription}`;
                document.getElementById('current-weather').textContent = currentWeatherText;
            })
            .catch(error => console.error(error));
    }

    function getWeatherDescription(weatherCode) {
    console.log("Weather code:", weatherCode); // Add this line

    if (weatherCode === 0) {
        return "Clear sky";
    } else if (weatherCode === 1 || weatherCode === 2 || weatherCode === 3) {
        return "Partly cloudy";
    } else if (weatherCode === 45 || weatherCode === 48) {
        return "Fog";
    } else if (weatherCode === 51 || weatherCode === 53 || weatherCode === 55) {
        return "Drizzle";
    } else if (weatherCode === 56 || weatherCode === 57) {
        return "Freezing Drizzle";
    } else if (weatherCode === 61 || weatherCode === 63 || weatherCode === 65) {
        return "Rainy";
    } else if (weatherCode === 66 || weatherCode === 67) {
        return "Freezing Rain";
    } else if (weatherCode === 71 || weatherCode === 73 || weatherCode === 75) {
        return "Snow fall";
    } else if (weatherCode === 77) {
        return "Snow grains";
    } else if (weatherCode === 80 || weatherCode === 81 || weatherCode === 82) {
        return "Rain showers";
    } else if (weatherCode === 85 || weatherCode === 86) {
        return "Snow showers";
    } else if (weatherCode === 95 || weatherCode === 96 || weatherCode === 99) {
        return "Thunderstorm";
    } else {
        return "Unknown weather";
    }
}

    // Get user's geolocation
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(position => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            getCurrentWeather(latitude, longitude);

            // Update the current weather every x milliseconds (e.g., 10 minutes)
            setInterval(() => getCurrentWeather(latitude, longitude), 600000); // 600000 ms = 10 minutes
        }, error => {
            console.error("Error getting geolocation:", error);
        });
    } else {
        console.error("Geolocation is not available in this browser.");
    }
</script></div>
                        </div>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"><span class="badge bg-danger badge-counter">3+</span><i class="fas fa-bell fa-fw"></i></a>
                                    <div class="dropdown-menu dropdown-menu-end dropdown-list animated--grow-in">
                                        <h6 class="dropdown-header">alerts center</h6><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="me-3">
                                                <div class="bg-primary icon-circle"><i class="fas fa-file-alt text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 12, 2019</span>
                                                <p>A new monthly report is ready to download!</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="me-3">
                                                <div class="bg-success icon-circle"><i class="fas fa-donate text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 7, 2019</span>
                                                <p>$290.29 has been deposited into your account!</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="me-3">
                                                <div class="bg-warning icon-circle"><i class="fas fa-exclamation-triangle text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 2, 2019</span>
                                                <p>Spending Alert: We've noticed unusually high spending for your account.</p>
                                            </div>
                                        </a><a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
                                    </div>
                                </div>
                            </li>
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="shadow dropdown-list dropdown-menu dropdown-menu-end" aria-labelledby="alertsDropdown"></div>
                            </li>
                            <div class="d-none d-sm-block topbar-divider"></div>
                            <li class="nav-item dropdown no-arrow">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"><?php
include 'setupdb.php';

// Get user_id from the session
$user_id = $_SESSION['user_id'];

// Fetch the full name from the database
$query = "SELECT CONCAT(fname, ' ', lname) AS full_name FROM business_owner WHERE id = $user_id";
$result = mysqli_query($conn, $query);

if ($result) {
    $row = mysqli_fetch_assoc($result);
    $full_name = $row['full_name'];
} else {
    // Handle query error
    $full_name = "Error retrieving name";
}
?>

<span class="d-none d-lg-inline me-2 text-gray-600 small"><?php echo $full_name; ?></span>
<?php
include 'setupdb.php';

$id = $_SESSION['user_id'];

// Define the directory paths for user and default images
$userImageDirectory = "http://localhost/AGRIDIVISION_FINAL/assets/img/business_owner/";

// Retrieve the profileimg from the database based on the user's details
// Assuming you have a database connection established in setupdb.php
$userProfileImg = ''; // Initialize with an empty string
$query = "SELECT profileimg FROM business_owner WHERE id = $id";
$result = mysqli_query($conn, $query);

if ($result && mysqli_num_rows($result) > 0) {
    $row = mysqli_fetch_assoc($result);
    $userProfileImg = $row['profileimg'];
}

$allowedFormats = ['jpeg', 'png', 'jpg']; // Allowed image formats

// Construct the image source path
foreach ($allowedFormats as $extension) {
    $path = $userImageDirectory . $userProfileImg . '.' . $extension;
    if (file_exists($path)) {
        break;  
    }
}
?>

<!-- Display the image if imagePath is set -->
        <img class="border rounded-circle img-profile" src="<?php echo $path; ?>" style="height: 30px; width: 30px;" alt="User Profile Image" />

        </a>
                                    <div class="dropdown-menu shadow dropdown-menu-end animated--grow-in"><a class="dropdown-item" href="businessprofile.php"><i class="fas fa-user fa-sm fa-fw me-2 text-gray-400"></i>&nbsp;Profile</a><a class="dropdown-item" data-bs-target="#logout" data-bs-toggle="modal"><i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>&nbsp;Logout</a></div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
                <div class="container-fluid">
                    <h3 class="text-dark mb-4"><strong>Marketplace</strong></h3>
                    <div class="row"><?php
include 'setupdb.php';

$businessid = $_SESSION['user_id']; // Assuming 'user_id' contains the farmer ID

$sql = "SELECT COUNT(*) AS total_rows FROM approved_transaction WHERE business_id = '$businessid'";
$result = $conn->query($sql);

// Check for errors in query execution
if ($result === false) {
    die("Database query error: " . $conn->error);
}

// Fetch the total count, or set it to "0" if there are no matching rows
$totalTransaction = ($result->num_rows > 0) ? $result->fetch_assoc()["total_rows"] : "0";
?>

<div class="col-md-3 col-lg-3 col-xl-3 mb-3">
    <div class="card shadow border-start-primary py-2" style="height: 130px;">
        <div class="card-body d-flex align-items-center">
            <div class="col me-2">
                <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#approvedModal" style="color: #ffcc49;">
                        <strong>APPROVED TRANSACTIONS</strong>
                    </a>
                </div>
                <div class="text-dark fw-bold h5 mb-0">
                    <?php echo $totalTransaction; ?>
                </div>
            </div>
            <div class="col-auto">
                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
        </div>
    </div>
</div>
<?php
include 'setupdb.php';

$businessid = $_SESSION['user_id']; // Assuming 'user_id' contains the farmer ID

$sql = "SELECT COUNT(*) AS total_rows FROM pending_transaction WHERE business_id = '$businessid'";
$result = $conn->query($sql);

// Check for errors in query execution
if ($result === false) {
    die("Database query error: " . $conn->error);
}

// Fetch the total count, or set it to "0" if there are no matching rows
$totalTransaction = ($result->num_rows > 0) ? $result->fetch_assoc()["total_rows"] : "0";
?>

<div class="col-md-3 col-lg-3 col-xl-3 mb-3">
    <div class="card shadow border-start-primary py-2" style="height: 130px;">
        <div class="card-body d-flex align-items-center">
            <div class="col me-2">
                <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#pendingModal" style="color: #ffcc49;">
                        <strong>PENDING TRANSACTIONS</strong>
                    </a>
                </div>
                <div class="text-dark fw-bold h5 mb-0">
                    <?php echo $totalTransaction; ?>
                </div>
            </div>
            <div class="col-auto">
                <i class="fas fa-hourglass-half fa-2x text-gray-300"></i>
            </div>
        </div>
    </div>
</div>
<?php
include 'setupdb.php';

$businessid = $_SESSION['user_id']; // Assuming 'user_id' contains the farmer ID

$sql = "SELECT COUNT(*) AS total_rows FROM declined_transaction WHERE business_id = '$businessid'";
$result = $conn->query($sql);

// Check for errors in query execution
if ($result === false) {
    die("Database query error: " . $conn->error);
}

// Fetch the total count, or set it to "0" if there are no matching rows
$totalTransaction = ($result->num_rows > 0) ? $result->fetch_assoc()["total_rows"] : "0";
?>

<div class="col-md-3 col-lg-3 col-xl-3 mb-3">
    <div class="card shadow border-start-primary py-2" style="height: 130px;">
        <div class="card-body d-flex align-items-center">
            <div class="col me-2">
                <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#declinedModal" style="color: #ffcc49;">
                        <strong>DECLINED TRANSACTIONS</strong>
                    </a>
                </div>
                <div class="text-dark fw-bold h5 mb-0">
                    <?php echo $totalTransaction; ?>
                </div>
            </div>
            <div class="col-auto">
                <i class="fas fa-times-circle fa-2x text-gray-300"></i>
            </div>
        </div>
    </div>
</div>
<?php
include 'setupdb.php';

$businessid = $_SESSION['user_id']; // Assuming 'user_id' contains the farmer ID

$sql = "SELECT COUNT(*) AS total_rows FROM done_transaction WHERE business_id = '$businessid'";
$result = $conn->query($sql);

// Check for errors in query execution
if ($result === false) {
    die("Database query error: " . $conn->error);
}

// Fetch the total count, or set it to "0" if there are no matching rows
$totalTransaction = ($result->num_rows > 0) ? $result->fetch_assoc()["total_rows"] : "0";
?>

<div class="col-md-3 col-lg-3 col-xl-3 mb-3">
    <div class="card shadow border-start-primary py-2" style="height: 130px;">
        <div class="card-body d-flex align-items-center">
            <div class="col me-2">
                <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#doneModal" style="color: #ffcc49;">
                        <strong>DONE TRANSACTIONS</strong>
                    </a>
                </div>
                <div class="text-dark fw-bold h5 mb-0">
                    <?php echo $totalTransaction; ?>
                </div>
            </div>
            <div class="col-auto">
                <i class="fas fa-truck fa-2x text-gray-300"></i>
            </div>
        </div>
    </div>
</div>
</div><div>
    <div>
    <div class="row" style="margin-bottom: 20px;">
        <style>
            /* Target the radio input when checked and set the background color */
            .form-check-input:checked {
                background-color: #ffcc49;
                border: 1px solid #ffcc49; /* Add border styling */
            }
        </style>
        
        <div class="col-12 col-md-8">
            <div class="row">
                <div class="col-6 col-md-3">
                    <div class="form-check">
                        <input id="formCheck-1" class="form-check-input" type="radio" name="category" value="all" checked />
                        <label class="form-check-label" for="formCheck-1">All</label>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="form-check">
                        <input id="formCheck-2" class="form-check-input" type="radio" name="category" value="corn" />
                        <label class="form-check-label" for="formCheck-2">Corn</label>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="form-check">
                        <input id="formCheck-3" class="form-check-input" type="radio" name="category" value="coffee" />
                        <label class="form-check-label" for="formCheck-3">Coffee</label>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="form-check">
                        <input id="formCheck-4" class="form-check-input" type="radio" name="category" value="coconut" />
                        <label class="form-check-label" for="formCheck-4">Coconut</label>
                    </div>
                </div>
            </div>
        </div>        
    </div>
</div>
<?php
include 'setupdb.php';
$crop = $_SESSION['crop'];
$page = isset($_GET['page']) ? $_GET['page'] : 1; // Get the current page number

$itemsPerPage = 10; // Number of items to display per page

// Calculate the starting point for the current page
$offset = ($page - 1) * $itemsPerPage;

$sql = "SELECT CONCAT(farmer_fname, ' ', farmer_lname) AS farmer_name, crop, ";
$sql .= "CONCAT_WS(', ', prov, mun, brgy, zip) AS location, ";
$sql .= "amount, price, date, id, farmer_id, farmer_fname, farmer_lname, prov, mun, brgy, street, zip, longitude, latitude FROM crop_information ";
$sql .= "LIMIT $itemsPerPage OFFSET $offset"; // Add LIMIT and OFFSET to limit the results

$result = $conn->query($sql);

// Check for errors in query execution
if ($result === false) {
    die("Database query error: " . $conn->error);
}

// Define the image directory
$userImageDirectory = "http://localhost/AGRIDIVISION_FINAL/assets/img/crops/";

// Store the data in an array
$cropData = [];
while ($row = $result->fetch_assoc()) {
    $cropData[] = $row;
}

// Separate the matching crop and the others
$matchingCrop = [];
$otherCrops = [];
foreach ($cropData as $row) {
    if (strcasecmp($row['crop'], $crop) === 0) {
        $matchingCrop[] = $row;
    } else {
        $otherCrops[] = $row;
    }
}

// Combine the matching crop and other crops arrays
$cropData = array_merge($matchingCrop, $otherCrops);
?>
<div class="row" id="productList">
    <?php foreach ($cropData as $row): ?>
        <?php if ($row['amount'] > 0): ?> <!-- Check if amount is greater than 0 -->
            <div class="col-lg-6 product-item" data-category="<?php echo strtolower($row['crop']); ?>">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <img src="<?php echo $userImageDirectory . getImageFilename($row['crop']); ?>" style="max-width: 100%; height: auto; display: block; margin: 0 auto;" />
                            </div>
                            <div class="col-12 col-md-6">
                                <a href="#" style="font-size: 25px; color: rgb(133, 135, 150);" data-bs-target="#productModal<?php echo $row['id']; ?>" data-bs-toggle="modal"><strong><?php echo $row['crop']; ?></strong></a>
                                <p><strong>Farmer Name:</strong></p>
                                <p style="margin-top: -20px;"><?php echo $row['farmer_name']; ?></p>
                                <p><strong>Location:</strong></p>
                                <p style="margin-top: -20px;"><a href="businessloc.php?id=<?php echo $row['farmer_id']; ?>"><?php echo $row['location']; ?></a></p>
                                <p><strong>Quantity:</strong></p>
                                <p style="margin-top: -20px;"><?php echo $row['amount'] . ' Kilograms'; ?></p>
                                <p><strong>Price Per Unit:</strong></p>
                                <p style="margin-top: -20px;"><?php echo '₱' . $row['price']; ?></p>
                                <p><strong>Date:</strong></p>
                                <p style="margin-top: -20px;"><?php echo date('F j, Y', strtotime($row['date'])); ?></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <?php endif; ?>
    <?php endforeach; ?>
</div>
<style>
.pagination-container {
    margin-top: 10px;
}

.pagination .page-link {
    background-color: #ffff !important;
    border-color: rgb(133,135,150) !important;
    color: rgb(133,135,150) !important; /* Text color for active page */
}

.pagination .page-link:hover {
    background-color: #ffff !important;
    border-color: rgb(133,135,150)!important;
    color: rgb(133,135,150)!important; /* Text color for hovered page */
}
</style>
<?php
$sql = "SELECT COUNT(*) AS total_rows FROM crop_information";
$result = $conn->query($sql);

if ($result === false) {
    die("Database query error: " . $conn->error);
}

$totalRows = $result->fetch_assoc()['total_rows'];
$totalPages = ceil($totalRows / $itemsPerPage);

// Check if total rows are greater than 10 (more than one page of data)
if ($totalRows > 10) {
    echo '<div class="pagination-container">';
    echo '<nav>';
    echo '<ul class="pagination">';

    // Previous Page Link
    if ($page > 1) {
        echo '<li class="page-item"><a class="page-link" href="?page=' . ($page - 1) . '" aria-label="Previous"><span aria-hidden="true">«</span></a></li>';
    } else {
        echo '<li class="page-item disabled"><span class="page-link" aria-hidden="true">«</span></li>';
    }

    // Page Links
    for ($i = 1; $i <= $totalPages; $i++) {
        $activeClass = ($i == $page) ? 'active' : '';
        echo '<li class="page-item ' . $activeClass . '"><a class="page-link" href="?page=' . $i . '">' . $i . '</a></li>';
    }

    // Next Page Link
    if ($page < $totalPages) {
        echo '<li class="page-item"><a class="page-link" href="?page=' . ($page + 1) . '" aria-label="Next"><span aria-hidden="true">»</span></a></li>';
    } else {
        echo '<li class="page-item disabled"><span class="page-link" aria-hidden="true">»</span></li>';
    }

    echo '</ul>';
    echo '</nav>';
    echo '</div>';
}
?>
    <?php foreach ($cropData as $row): ?>
    <div id="productModal<?php echo $row['id']; ?>" class="modal fade" role="dialog" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><strong>Product Info</strong></h4>
                    <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row">
                            <!-- Populate the modal with relevant data -->
                            <div class="col-md-12 col-xl-6">
                                <img src="<?php echo $userImageDirectory . getImageFilename($row['crop']); ?>" style="width: 100%; height: auto;" />
                            </div>
                            <div class="col-md-12 col-xl-6">
                                <h1><strong><?php echo $row['crop']; ?></strong></h1>
                                <p><strong>Farmer Name:</strong></p>
                                <p style="margin-top: -20px;"><?php echo $row['farmer_name']; ?></p>
                                <p><strong>Location:</strong></p>
                                <p style="margin-top: -20px;"><?php echo $row['location']; ?></p>
                                <p><strong>Price:</strong></p>
                                <p style="margin-top: -20px;"><?php echo '₱' . $row['price']; ?></p>
                                <p><strong>Amount Available:</strong></p>
                                <p style="margin-top: -20px;"><?php echo $row['amount'] . ' Kilograms'; ?></p>
                                <!-- Form for adding to cart -->
                                <form method="post" action="businessmarket.php" enctype="multipart/form-data" target="_self" onsubmit="return validateAmount(<?php echo $row['id']; ?>)">
                                    <p><strong>Input Amount to Add to Cart:</strong></p>
                                    <input class="form-control" type="number" name="amount_buy" id="amountInput<?php echo $row['id']; ?>" required 
                                           data-available-amount="<?php echo $row['amount']; ?>" />
                                    <input type="hidden" name="farmer_id" value="<?php echo $row['farmer_id']; ?>" />
                                    <input type="hidden" name="farmer_fname" value="<?php echo $row['farmer_fname']; ?>" />
                                    <input type="hidden" name="farmer_lname" value="<?php echo $row['farmer_lname']; ?>" />
                                    <input type="hidden" name="farmer_prov" value="<?php echo $row['prov']; ?>" />
                                    <input type="hidden" name="farmer_mun" value="<?php echo $row['mun']; ?>" />
                                    <input type="hidden" name="farmer_brgy" value="<?php echo $row['brgy']; ?>" />
                                    <input type="hidden" name="farmer_street" value="<?php echo $row['street']; ?>" />
                                    <input type="hidden" name="farmer_zip" value="<?php echo $row['zip']; ?>" />
                                    <input type="hidden" name="farmer_longitude" value="<?php echo $row['longitude']; ?>" />
                                    <input type="hidden" name="farmer_latitude" value="<?php echo $row['latitude']; ?>" />
                                    <input type="hidden" name="crop" value="<?php echo $row['crop']; ?>" />
                                    <input type="hidden" name="amount" value="<?php echo $row['amount']; ?>" />
                                    <input type="hidden" name="price" value="<?php echo $row['price']; ?>" />
                                    <p id="error<?php echo $row['id']; ?>" style="display: none; color: #931638;">Input Exceeds Available Amount.</p>
                                    <button class="btn btn-primary" type="submit" style="margin-top: 10px; background: #ffcc49; border-color: #ffcc49;">
                                        Add to Cart <i class="fas fa-shopping-cart"></i>
                                    </button>
                                </form>
                                <script>
                                    function validateAmount(productId) {
                                        var inputAmount = parseInt(document.getElementById("amountInput" + productId).value);
                                        var availableAmount = parseInt(document.getElementById("amountInput" + productId).getAttribute("data-available-amount"));
                                        
                                        if (inputAmount > availableAmount) {
                                            // Display error message
                                            document.getElementById("error" + productId).style.display = "block";
                                            return false; // Prevent form submission
                                        } else {
                                            // Hide error message
                                            document.getElementById("error" + productId).style.display = "none";
                                            return true; // Allow form submission
                                        }
                                    }
                                </script>
                                                                                                                                                    
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    
    <?php endforeach; ?>

    <?php
    // Function to determine the image filename based on crop name
    function getImageFilename($cropName) {
        switch ($cropName) {
            case 'Corn':
                return 'Corn.png';
            case 'Coffee':
                return 'Coffee.png';
            case 'Coconut':
                return 'Coconut.png';
            default:
                return 'default.png'; // You can specify a default image filename here
        }
    }
    ?>
</div>

<script>
    // JavaScript code to handle filtering based on radio buttons
    const categoryRadios = document.querySelectorAll('input[name="category"]');
    const productItems = document.querySelectorAll('.product-item');

    categoryRadios.forEach((radio) => {
        radio.addEventListener('change', () => {
            const selectedCategory = radio.value;
            productItems.forEach((item) => {
                if (selectedCategory === 'all' || item.getAttribute('data-category') === selectedCategory) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
</script>

                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span><strong>AgriDivision © Brand 2023</strong></span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>
    <div class="modal fade" role="dialog" tabindex="-1" id="logout">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content"><div class="modal-header"></div>
                <div class="modal-body">
                    <p>Are you sure you want to log out?<br></p>
                </div>
                <div class="modal-footer"><button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button><a class="btn btn-primary" role="button" href="logout.php" style="background: #ffcc46;border-color: #ffcc49;">Yes</a></div>
            </div>
        </div>
    </div>
    <div class="modal fade" role="dialog" tabindex="-1" id="approvedModal">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><strong>Approved Transactions</strong></h4><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container"><?php
include 'setupdb.php';

$businessid = $_SESSION['user_id'];
$businessfname = $_SESSION['fname'];
$businesslname = $_SESSION['lname'];
$business_prov = $_SESSION['prov'];
$business_mun = $_SESSION['mun'];
$business_brgy = $_SESSION['brgy'];
$business_street = $_SESSION['street'];
$business_zip = $_SESSION['zip'];
$business_longitude = $_SESSION['longitude'];
$business_latitude = $_SESSION['latitude'];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['mark_as_done'])) {
    $id = $_POST['id'];

    // Retrieve data for the selected approved transaction
    $query = "SELECT farmer_id, farmer_fname, farmer_lname, farmer_prov, farmer_mun, farmer_brgy, farmer_street, farmer_zip, farmer_longitude, farmer_latitude, crop, amount, price, amount_buy, date FROM approved_transaction WHERE id = $id";
    $result = mysqli_query($conn, $query);

    if ($row = mysqli_fetch_assoc($result)) {
        $farmer_id = $row['farmer_id'];
        $farmer_fname = $row['farmer_fname'];
        $farmer_lname = $row['farmer_lname'];
        $farmer_prov = $row['farmer_prov'];
        $farmer_mun = $row['farmer_mun'];
        $farmer_brgy = $row['farmer_brgy'];
        $farmer_street = $row['farmer_street'];
        $farmer_zip = $row['farmer_zip'];
        $farmer_longitude = $row['farmer_longitude'];
        $farmer_latitude = $row['farmer_latitude'];
        $crop = $row['crop'];
        $amount = $row['amount'];
        $price = $row['price'];
        $amount_buy = $row['amount_buy'];
        $date = $row['date'];

        // Insert data into the done_transaction table
        $insertQuery = "INSERT INTO done_transaction (farmer_id, farmer_fname, farmer_lname, farmer_prov, farmer_mun, farmer_brgy, farmer_street, farmer_zip, farmer_longitude, farmer_latitude, business_id, business_fname, business_lname, business_prov, business_mun, business_brgy, business_street, business_zip, business_longitude, business_latitude, crop, amount, price, amount_buy, date) 
        VALUES ($farmer_id, '$farmer_fname', '$farmer_lname', '$farmer_prov', '$farmer_mun', '$farmer_brgy', '$farmer_street', '$farmer_zip', '$farmer_longitude', '$farmer_latitude', $businessid, '$businessfname', '$businesslname', '$business_prov', '$business_mun', '$business_brgy', '$business_street', '$business_zip', '$business_longitude', '$business_latitude', '$crop', '$amount', '$price', '$amount_buy', '$date')";
        mysqli_query($conn, $insertQuery);


        // Delete the data from the approved_transaction table
        $deleteQuery = "DELETE FROM approved_transaction WHERE id = $id";
        mysqli_query($conn, $deleteQuery);

        // Insert data into the business_stocks table
        $insertStockQuery = "INSERT INTO business_stocks (business_id, fname, lname, crop, amount, date) VALUES ($businessid, '$businessfname', '$businesslname', '$crop', $amount_buy, '$date')";            
        mysqli_query($conn, $insertStockQuery);
        
        // Check if the entry already exists in the total_order table
        $checkTotalOrderQuery = "SELECT * FROM total_order WHERE business_id = $businessid AND crop = '$crop'";
        $totalOrderResult = mysqli_query($conn, $checkTotalOrderQuery);

        if (mysqli_num_rows($totalOrderResult) > 0) {
            // If the entry already exists, update it by adding the new amount to the total_amount
            $totalOrderRow = mysqli_fetch_assoc($totalOrderResult);
            $totalOrderId = $totalOrderRow['id'];
            $totalAmount = $totalOrderRow['total_amount'];

            $updateTotalOrderQuery = "UPDATE total_order SET total_amount = total_amount + $amount_buy WHERE id = $totalOrderId";
            mysqli_query($conn, $updateTotalOrderQuery);
        } else {
            // If the entry does not exist, insert it
            $insertTotalOrderQuery = "INSERT INTO total_order (business_id, business_fname, business_lname, crop, total_amount, date) VALUES ($businessid, '$businessfname', '$businesslname', '$crop', $amount_buy, '$date')";
            mysqli_query($conn, $insertTotalOrderQuery);
        }

        // Update or insert data into specific crop_data tables
$currentYear = date("Y");
$month = date("M");

switch ($crop) {
    case 'Corn':
        $updateInsertQuery = "INSERT INTO corn_data (Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, `Dec`, `Year`) 
                              VALUES (0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, $currentYear) 
                              ON DUPLICATE KEY UPDATE 
                              Jan = IF('$month' = 'Jan', Jan + $amount_buy, Jan + 0),
                              Feb = IF('$month' = 'Feb', Feb + $amount_buy, Feb + 0),
                              Mar = IF('$month' = 'Mar', Mar + $amount_buy, Mar + 0),
                              Apr = IF('$month' = 'Apr', Apr + $amount_buy, Apr + 0),
                              May = IF('$month' = 'May', May + $amount_buy, May + 0),
                              Jun = IF('$month' = 'Jun', Jun + $amount_buy, Jun + 0),
                              Jul = IF('$month' = 'Jul', Jul + $amount_buy, Jul + 0),
                              Aug = IF('$month' = 'Aug', Aug + $amount_buy, Aug + 0),
                              Sep = IF('$month' = 'Sep', Sep + $amount_buy, Sep + 0),
                              Oct = IF('$month' = 'Oct', Oct + $amount_buy, Oct + 0),
                              Nov = IF('$month' = 'Nov', Nov + $amount_buy, Nov + 0),
                              `Dec` = IF('$month' = 'Dec', `Dec` + $amount_buy, `Dec` + 0)";
        break;

    case 'Coffee':
        $updateInsertQuery = "INSERT INTO coffee_data (Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, `Dec`, `Year`) 
                              VALUES (0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, $currentYear) 
                              ON DUPLICATE KEY UPDATE 
                              Jan = IF('$month' = 'Jan', Jan + $amount_buy, Jan + 0),
                              Feb = IF('$month' = 'Feb', Feb + $amount_buy, Feb + 0),
                              Mar = IF('$month' = 'Mar', Mar + $amount_buy, Mar + 0),
                              Apr = IF('$month' = 'Apr', Apr + $amount_buy, Apr + 0),
                              May = IF('$month' = 'May', May + $amount_buy, May + 0),
                              Jun = IF('$month' = 'Jun', Jun + $amount_buy, Jun + 0),
                              Jul = IF('$month' = 'Jul', Jul + $amount_buy, Jul + 0),
                              Aug = IF('$month' = 'Aug', Aug + $amount_buy, Aug + 0),
                              Sep = IF('$month' = 'Sep', Sep + $amount_buy, Sep + 0),
                              Oct = IF('$month' = 'Oct', Oct + $amount_buy, Oct + 0),
                              Nov = IF('$month' = 'Nov', Nov + $amount_buy, Nov + 0),
                              `Dec` = IF('$month' = 'Dec', `Dec` + $amount_buy, `Dec` + 0)";
        break;

    case 'Coconut':
        $updateInsertQuery = "INSERT INTO coconut_data (Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, `Dec`, `Year`) 
                              VALUES (0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, $currentYear) 
                              ON DUPLICATE KEY UPDATE 
                              Jan = IF('$month' = 'Jan', Jan + $amount_buy, Jan + 0),
                              Feb = IF('$month' = 'Feb', Feb + $amount_buy, Feb + 0),
                              Mar = IF('$month' = 'Mar', Mar + $amount_buy, Mar + 0),
                              Apr = IF('$month' = 'Apr', Apr + $amount_buy, Apr + 0),
                              May = IF('$month' = 'May', May + $amount_buy, May + 0),
                              Jun = IF('$month' = 'Jun', Jun + $amount_buy, Jun + 0),
                              Jul = IF('$month' = 'Jul', Jul + $amount_buy, Jul + 0),
                              Aug = IF('$month' = 'Aug', Aug + $amount_buy, Aug + 0),
                              Sep = IF('$month' = 'Sep', Sep + $amount_buy, Sep + 0),
                              Oct = IF('$month' = 'Oct', Oct + $amount_buy, Oct + 0),
                              Nov = IF('$month' = 'Nov', Nov + $amount_buy, Nov + 0),
                              `Dec` = IF('$month' = 'Dec', `Dec` + $amount_buy, `Dec` + 0)";
        break;
}


        mysqli_query($conn, $updateInsertQuery);
    }

    // Redirect back to the businessmarket.php page
    echo '<script>window.location.replace("businessmarket.php");</script>';
}

$query = "SELECT id, CONCAT(farmer_fname, ' ', farmer_lname) AS full_name, crop, amount, amount_buy, date FROM approved_transaction WHERE business_id = $businessid";
$result = mysqli_query($conn, $query);
?>

<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Amount Purchased</th>
                <th>Date</th>
                <th>Mark as Done</th>
            </tr>
        </thead>
        <tbody>
            <?php
            while ($row = mysqli_fetch_assoc($result)) {
                $id = $row['id'];
                $fullName = $row['full_name'];
                $amount = $row['amount_buy'];
                $date = $row['date'];
            ?>
            <tr>
                <td>
                    <p><?php echo $fullName; ?></p>
                </td>
                <td>
                    <p><?php echo $amount; ?> Kilograms</p>
                </td>
                <td>
                    <p><?php echo date("F j, Y", strtotime($date)); ?></p>
                </td>
                <td class="d-inline-flex" style="width: 25%;">
                    <form method="post" action="">
                        <input type="hidden" name="id" value="<?php echo $id; ?>">
                        <button class="btn btn-primary pull-right" type="submit" name="mark_as_done" style="margin-right: 20px; background: #54b7c6; border-color: #54b7c6;"><i class="fa fa-check"></i></button>
                    </form>
                </td>
            </tr>
            <?php
            }
            ?>
        </tbody>
    </table>
</div>
</div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" role="dialog" tabindex="-1" id="pendingModal">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><strong>Pending Transactions</strong></h4><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container"><div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Amount</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <?php
            include 'setupdb.php';
            $businessid = $_SESSION['user_id'];

            $query = "SELECT CONCAT(farmer_fname, ' ', farmer_lname) AS full_name, amount_buy, date FROM pending_transaction WHERE business_id = $businessid";
            $result = mysqli_query($conn, $query);

            while($row = mysqli_fetch_assoc($result)) {
                $fullName = $row['full_name'];
                $amount_buy = $row['amount_buy'];
                $date = $row['date'];
            ?>
            <tr>
                <td>
                    <p><?php echo $fullName; ?></p>
                </td>
                <td>
                    <p><?php echo $amount_buy; ?> Kilograms</p>
                </td>
                <td>
                    <p><?php echo $date; ?></p>
                </td>            
            </tr>
            <?php
            }
            ?>
        </tbody>
    </table>
</div>
</div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" role="dialog" tabindex="-1" id="declinedModal">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><strong>Declined Transactions</strong></h4><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container"><div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Amount</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <?php
            include 'setupdb.php';
            $businessid = $_SESSION['user_id'];

            $query = "SELECT CONCAT(farmer_fname, ' ', farmer_lname) AS full_name, amount, date FROM declined_transaction WHERE business_id = $businessid";
            $result = mysqli_query($conn, $query);

            while($row = mysqli_fetch_assoc($result)) {
                $fullName = $row['full_name'];
                $amount = $row['amount'];
                $date = $row['date'];
            ?>
            <tr>
                <td>
                <p><?php echo $fullName; ?></p>
                </td>
                <td>
                <p><?php echo $amount; ?> Kilograms</p>
                </td>
                <td>
   				 <p><?php echo date("F j, Y", strtotime($date)); ?></p>
                </td>                
            </tr>
            <?php
            }
            ?>
        </tbody>
    </table>
</div>
</div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" role="dialog" tabindex="-1" id="doneModal">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><strong>Done Transactions</strong></h4><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container"><div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Amount</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <?php
            include 'setupdb.php';
            $businessid = $_SESSION['user_id'];

            $query = "SELECT CONCAT(farmer_fname, ' ', farmer_lname) AS full_name, amount, date FROM done_transaction WHERE business_id = $businessid";
            $result = mysqli_query($conn, $query);

            while($row = mysqli_fetch_assoc($result)) {
                $fullName = $row['full_name'];
                $amount = $row['amount'];
                $date = $row['date'];
            ?>
            <tr>
                <td>
                    <p><?php echo $fullName; ?></p>
                </td>
                <td>
<p><?php echo $amount; ?> Kilograms</p>
                </td>
                <td>
   				 <p><?php echo date("F j, Y", strtotime($date)); ?></p>
                </td>                  
            </tr>
            <?php
            }
            ?>
        </tbody>
    </table>
</div>
</div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/theme.js"></script>
</body>

</html>