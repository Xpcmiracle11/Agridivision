<?php
include 'setupdb.php';

$municipal_municipality = $_SESSION['municipality'];

// Function to get latitude and longitude for a municipality using Google Maps Geocoding API
function getCoordinatesForMunicipality($municipality)
{
    $apiKey = 'YOUR_GOOGLE_MAPS_API_KEY';
    $encodedMunicipality = urlencode($municipality);

    // Make the API request
    $apiUrl = "https://maps.googleapis.com/maps/api/geocode/json?address=$encodedMunicipality&key=$apiKey";
    $response = file_get_contents($apiUrl);
    $data = json_decode($response, true);

    if ($data && $data['status'] === 'OK') {
        $location = $data['results'][0]['geometry']['location'];
        return [
            'lat' => $location['lat'],
            'lng' => $location['lng']
        ];
    }

    return null;
}

// Get coordinates for the center of the map
$mapCenter = getCoordinatesForMunicipality($municipal_municipality);

// Fetch data from the database
$sqlMap = "SELECT farmer_barangay, commodity_name, SUM(amount) as total_amount FROM production WHERE farmer_municipality = '$municipal_municipality' GROUP BY farmer_barangay, commodity_name";
$resultMap = mysqli_query($conn, $sqlMap);

// Fetch all barangay and their total amounts
$barangayData = [];
while ($row = mysqli_fetch_assoc($resultMap)) {
    $barangayName = trim(strtolower($row['farmer_barangay']));

    if (!isset($barangayData[$barangayName])) {
        $barangayData[$barangayName] = [];
    }

    $barangayData[$barangayName][] = [
        'commodity_name' => $row['commodity_name'],
        'total_amount' => $row['total_amount']
    ];
}

$uniqueCommodities = array_unique(array_reduce($barangayData, function($carry, $item) {
    return array_merge($carry, array_column($item, 'commodity_name'));
}, []));
?>

<div class="col-lg-7 col-xl-8 col-xxl-12">
    <div class="card shadow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="text-primary fw-bold m-0">Allocation</h6>
            <!-- Add the select input for commodities -->
            <select id="commoditySelect" class="form-select" onchange="updateMap()" style="width: 50%;">
                <?php
                foreach ($uniqueCommodities as $commodity) {
                    echo "<option value='" . $commodity . "'>" . $commodity . "</option>";
                }
                ?>
            </select>
        </div>
        <div class="card-body">
            <div id="map" style="height: 400px;"></div>
        </div>
    </div>
</div>

<script>
    var barangayData = <?php echo json_encode(array_change_key_case($barangayData, CASE_LOWER)); ?>;
    var selectedCommodity = null; // Variable to store the selected commodity

    function initScript() {
        var mapScript = document.createElement('script');
        mapScript.src = 'https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap';
        mapScript.async = true;
        mapScript.defer = true;
        document.head.appendChild(mapScript);
    }

    initScript();

    function initMap() {
        updateMap();
    }

    function updateMap() {
        selectedCommodity = document.getElementById('commoditySelect').value;

        var map = new google.maps.Map(document.getElementById('map'), {
            center: <?php echo json_encode($mapCenter); ?>,
            zoom: 9,
            mapTypeId: 'hybrid'
        });

        var infoWindow = new google.maps.InfoWindow();

        // Load filtered GeoJSON data for Iloilo
        map.data.addGeoJson(<?php echo $filteredGeoJson; ?>);

        map.data.setStyle(function (feature) {
            try {
                var geometry = feature.getGeometry();

                if (geometry.getType() === 'Polygon') {
                    var barangayName = feature.getProperty("NAME_3") ? feature.getProperty("NAME_3").trim().toLowerCase() : null;

                    if (barangayData.hasOwnProperty(barangayName)) {
                        var commodityData = barangayData[barangayName].find(item => item.commodity_name === selectedCommodity);

                        if (commodityData) {
                            var fillColor = commodityData.total_amount > 100 ? '#FF0000' : commodityData.total_amount > 50 ? '#FFFF00' : '#00FF00';

                            return {
                                fillColor: fillColor,
                                strokeColor: '#000000',
                                strokeWeight: 2
                            };
                        }
                    }
                    return {
                        fillColor: 'transparent',
                        strokeColor: 'transparent',
                        strokeWeight: 2
                    };
                } else {
                    console.error("Unsupported geometry type:", geometry.getType());
                    return {
                        fillColor: 'transparent',
                        strokeColor: 'transparent',
                        strokeWeight: 2
                    };
                }
            } catch (error) {
                console.error("Error processing GeoJSON feature:", error);
                return {
                    fillColor: 'transparent',
                    strokeColor: 'transparent',
                    strokeWeight: 2
                };
            }
        });

        map.data.addListener('click', function (event) {
            var barangayName = event.feature.getProperty("NAME_3") ? event.feature.getProperty("NAME_3").trim().toLowerCase() : null;

            if (barangayData.hasOwnProperty(barangayName)) {
                var commodityData = barangayData[barangayName].find(item => item.commodity_name === selectedCommodity);

                if (commodityData) {
                    var capitalizedBarangayName = barangayName.charAt(0).toUpperCase() + barangayName.slice(1);

                    var content = '<b>Barangay:</b> ' + capitalizedBarangayName + '<br>' +
                        '<b>Commodity:</b> ' + commodityData.commodity_name + '<br>' +
                        '<b>Total Amount:</b> ' + commodityData.total_amount + " Kilograms" + '<br>';

                    infoWindow.setContent(content);
                    infoWindow.setPosition(event.latLng);
                    infoWindow.open(map);
                }
            }
        });
    }
</script>
